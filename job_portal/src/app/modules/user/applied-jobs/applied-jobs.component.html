<app-header></app-header>

<div class="applied-jobs-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1>My Applied Jobs</h1>
    <p class="page-subtitle">Track and manage your job applications</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading your applications...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-state">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Oops! Something went wrong</h3>
    <p>{{ error }}</p>
    <button (click)="loadApplications()" class="retry-btn">Try Again</button>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && !error && applications.length === 0" class="empty-state">
    <div class="empty-icon">üìã</div>
    <h3>No Applications Yet</h3>
    <p>You haven't applied to any jobs yet. Start your job search today!</p>
    <a routerLink="/user/job-search" class="browse-jobs-button">Browse Jobs</a>
  </div>

  <!-- Applications List -->
  <div *ngIf="!isLoading && !error && applications.length > 0" class="applications-content">
    <!-- Stats Summary -->
    <div class="stats-summary">
      <div class="stat-card">
        <div class="stat-number">{{ applications.length }}</div>
        <div class="stat-label">Total Applications</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ getApplicationsByStatus('Under Review').length }}</div>
        <div class="stat-label">Under Review</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ getApplicationsByStatus('Interview').length }}</div>
        <div class="stat-label">Interviews</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ getApplicationsByStatus('Accepted').length }}</div>
        <div class="stat-label">Accepted</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label>Sort by:</label>
        <select (change)="sortApplications($event)" [value]="currentSort">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="status">Status</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Filter by status:</label>
        <select (change)="filterByStatus($event)" [value]="selectedStatus">
          <option value="all">All Applications</option>
          <option value="Applied">Applied</option>
          <option value="Under Review">Under Review</option>
          <option value="Interview">Interview</option>
          <option value="Rejected">Rejected</option>
          <option value="Accepted">Accepted</option>
          <option value="Withdrawn">Withdrawn</option>
        </select>
      </div>
    </div>

    <!-- Application Cards -->
    <div class="application-cards">
      <div *ngFor="let item of filteredApplications" class="application-card">
        <!-- Job Information -->
        <div class="job-info">
          <div class="company-logo" [style.background-color]="item.job.color">
            {{ getCompanyInitials(item.job.company) }}
          </div>
          <div class="job-details">
            <h3 class="job-title">{{ item.job.title }}</h3>
            <p class="company-name">{{ item.job.company }}</p>
            <p class="job-location">{{ item.job.location }}</p>
            <p class="job-type">{{ item.job.experience }} ‚Ä¢ ‚Çπ{{ item.job.salary | number }}</p>
          </div>
        </div>
        
        <!-- Application Status -->
        <div class="application-details">
          <div class="status-section">
            <span class="status-badge {{ getStatusClass(item.application.status) }}">
              {{ item.application.status }}
            </span>
            <span class="applied-date">
              Applied on {{ item.application.applicationDate | date:'mediumDate' }}
            </span>
            <span class="application-type" [class.quick-apply]="item.application.quickApply">
              {{ item.application.quickApply ? 'Quick Apply' : 'Custom Apply' }}
            </span>
          </div>

          <!-- Application Information -->
          <div class="application-info" *ngIf="!item.application.quickApply">
            <div class="info-row" *ngIf="item.application.fullName">
              <strong>Name:</strong> {{ item.application.fullName }}
            </div>
            <div class="info-row" *ngIf="item.application.email">
              <strong>Email:</strong> {{ item.application.email }}
            </div>
            <div class="info-row" *ngIf="item.application.phone">
              <strong>Phone:</strong> {{ item.application.phone }}
            </div>
            <div class="info-row" *ngIf="item.application.resumePath">
              <strong>Resume:</strong> {{ item.application.resumePath }}
            </div>
            <div class="info-row cover-letter" *ngIf="item.application.coverLetter">
              <strong>Cover Letter:</strong>
              <p class="cover-letter-text">{{ item.application.coverLetter }}</p>
            </div>
          </div>
          
          <!-- Quick Apply Information -->
          <div class="application-info" *ngIf="item.application.quickApply">
            <div class="info-row">
              <em>Applied using your profile information</em>
            </div>
          </div>
          
          <!-- Actions -->
          <div class="actions">
            <button 
              (click)="viewJobDetails(item.application.jobId)" 
              class="action-btn view-btn">
              View Job
            </button>
            
            <button 
              (click)="viewApplicationDetails(item.application)" 
              class="action-btn details-btn">
              View Details
            </button>
            
            <button 
              *ngIf="canEdit(item.application.status)"
              (click)="editApplication(item.application)" 
              class="action-btn edit-btn">
              Edit
            </button>
            
            <button 
              *ngIf="canWithdraw(item.application.status)"
              (click)="withdrawApplication(+item.application.id!)" 
              class="action-btn withdraw-btn">
              Withdraw
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Application Modal -->
  <div *ngIf="showEditModal" class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Edit Application</h3>
        <button (click)="closeEditModal()" class="close-btn">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" [(ngModel)]="editForm.fullName" class="form-input">
        </div>
        
        <div class="form-group">
          <label>Email</label>
          <input type="email" [(ngModel)]="editForm.email" class="form-input">
        </div>
        
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" [(ngModel)]="editForm.phone" class="form-input">
        </div>
        
        <div class="form-group">
          <label>Cover Letter</label>
          <textarea [(ngModel)]="editForm.coverLetter" class="form-textarea resize-none" rows="4" 
                    (input)="updateCoverLetterCount()"></textarea>
          <div class="word-count">
            <span>{{ getCoverLetterWordCount() }} words | {{ getCoverLetterCharCount() }} characters</span>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button (click)="closeEditModal()" class="cancel-btn">Cancel</button>
        <button (click)="saveEditedApplication()" class="save-btn">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Application Details Modal -->
  <div *ngIf="showDetailsModal" class="modal-overlay" (click)="closeDetailsModal()">
    <div class="modal-content application-details-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Application Details</h3>
        <button (click)="closeDetailsModal()" class="close-btn">&times;</button>
      </div>
      
      <div class="modal-body" *ngIf="selectedApplication">
        <div class="details-section">
          <h4>Application Information</h4>
          <div class="details-grid">
            <div class="detail-item">
              <label>Application Type:</label>
              <span class="application-type" [class.quick-apply]="selectedApplication.quickApply">
                {{ selectedApplication.quickApply ? 'Quick Apply' : 'Custom Apply' }}
              </span>
            </div>
            <div class="detail-item">
              <label>Applied Date:</label>
              <span>{{ selectedApplication.applicationDate | date:'full' }}</span>
            </div>
            <div class="detail-item">
              <label>Status:</label>
              <span class="status-badge {{ getStatusClass(selectedApplication.status) }}">
                {{ selectedApplication.status }}
              </span>
            </div>
          </div>
        </div>

        <div class="details-section" *ngIf="!selectedApplication.quickApply">
          <h4>Personal Information</h4>
          <div class="details-grid">
            <div class="detail-item" *ngIf="selectedApplication.fullName">
              <label>Full Name:</label>
              <span>{{ selectedApplication.fullName }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedApplication.email">
              <label>Email:</label>
              <span>{{ selectedApplication.email }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedApplication.phone">
              <label>Phone:</label>
              <span>{{ selectedApplication.phone }}</span>
            </div>
          </div>
        </div>

        <div class="details-section" *ngIf="selectedApplication.quickApply">
          <h4>Applied Using Profile</h4>
          <p class="profile-info">This application was submitted using your saved profile information including your resume, contact details, and professional information.</p>
        </div>

        <div class="details-section" *ngIf="selectedApplication.resumePath">
          <h4>Resume</h4>
          <div class="resume-info">
            <i class="fas fa-file-pdf"></i>
            <span>{{ selectedApplication.resumePath }}</span>
            <button class="download-btn" *ngIf="selectedApplication.resumePath">
              <i class="fas fa-download"></i> Download
            </button>
          </div>
        </div>

        <div class="details-section" *ngIf="selectedApplication.coverLetter">
          <h4>Cover Letter</h4>
          <div class="cover-letter-content">
            <p>{{ selectedApplication.coverLetter }}</p>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button (click)="closeDetailsModal()" class="close-modal-btn">Close</button>
      </div>
    </div>
  </div>
</div>